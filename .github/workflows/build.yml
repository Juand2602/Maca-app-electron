name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install root dependencies
        run: npm ci

      - name: ğŸ“¦ Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: ğŸ—„ï¸ Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      - name: ğŸ”¨ Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“¥ Download Node.js portable (via prebuild script)
        run: npm run prebuild

      - name: ğŸ” Verify Node.js portable download
        run: |
          Write-Host "=== VERIFYING NODE.JS PORTABLE ===" -ForegroundColor Cyan
          
          $nodeExe = "node-portable\node.exe"
          
          if (Test-Path $nodeExe) {
            $size = (Get-Item $nodeExe).Length / 1MB
            Write-Host "âœ… node.exe found!" -ForegroundColor Green
            Write-Host "   Path: $nodeExe"
            Write-Host "   Size: $([math]::Round($size, 2)) MB"
            
            if ($size -gt 20) {
              Write-Host "   âœ… Size OK (>20MB)" -ForegroundColor Green
            } else {
              Write-Host "   âŒ ERROR: File too small, might be corrupted" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "âŒ ERROR: node.exe NOT FOUND!" -ForegroundColor Red
            Write-Host "Directory contents:" -ForegroundColor Yellow
            if (Test-Path "node-portable") {
              Get-ChildItem "node-portable" | ForEach-Object { Write-Host "   - $($_.Name)" }
            } else {
              Write-Host "   node-portable directory doesn't exist!" -ForegroundColor Red
            }
            exit 1
          }
        shell: pwsh

      - name: ğŸ” Verify backend structure
        working-directory: backend
        run: |
          Write-Host "=== BACKEND STRUCTURE ===" -ForegroundColor Cyan
          
          # Verificar app.js
          if (Test-Path "src/app.js") {
            Write-Host "âœ… app.js" -ForegroundColor Green
          } else {
            Write-Host "âŒ app.js NOT FOUND" -ForegroundColor Red
            exit 1
          }
          
          # Verificar rutas
          $routes = Get-ChildItem "src/routes" -Filter "*.js" -ErrorAction SilentlyContinue
          if ($routes) {
            Write-Host "âœ… Routes: $($routes.Count) files" -ForegroundColor Green
          } else {
            Write-Host "âŒ No routes found" -ForegroundColor Red
            exit 1
          }
          
          # Verificar Prisma Client
          if (Test-Path "node_modules/.prisma/client") {
            Write-Host "âœ… Prisma Client generated" -ForegroundColor Green
          } else {
            Write-Host "âŒ Prisma Client NOT generated" -ForegroundColor Red
            exit 1
          }
          
          # Verificar dependencias crÃ­ticas
          $criticalDeps = @("express", "cors", "@prisma/client", "bcryptjs", "jsonwebtoken")
          foreach ($dep in $criticalDeps) {
            if (Test-Path "node_modules/$dep") {
              Write-Host "âœ… $dep" -ForegroundColor Green
            } else {
              Write-Host "âŒ $dep MISSING" -ForegroundColor Red
              exit 1
            }
          }
        shell: pwsh

      - name: ğŸ“± Build Electron App
        run: npm run electron:build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Verify build output
        run: |
          Write-Host "=== BUILD OUTPUT ===" -ForegroundColor Cyan
          
          # Verificar instalador
          $installer = Get-ChildItem "dist-electron" -Filter "*Setup*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($installer) {
            $sizeMB = [math]::Round($installer.Length / 1MB, 2)
            Write-Host "âœ… Installer: $($installer.Name) ($sizeMB MB)" -ForegroundColor Green
          } else {
            Write-Host "âŒ Installer NOT found" -ForegroundColor Red
            exit 1
          }
          
          # Verificar Node.js en resources
          $nodeInResources = "dist-electron\win-unpacked\resources\node\node.exe"
          if (Test-Path $nodeInResources) {
            $nodeSize = [math]::Round((Get-Item $nodeInResources).Length / 1MB, 2)
            Write-Host "âœ… Node.js included in build: $nodeSize MB" -ForegroundColor Green
          } else {
            Write-Host "âŒ Node.js NOT included in build!" -ForegroundColor Red
            Write-Host "Resources directory structure:" -ForegroundColor Yellow
            if (Test-Path "dist-electron\win-unpacked\resources") {
              Get-ChildItem "dist-electron\win-unpacked\resources" -Recurse | Select-Object FullName | ForEach-Object { Write-Host "   $($_.FullName)" }
            }
            exit 1
          }
          
          # Verificar backend en resources
          $backendInResources = "dist-electron\win-unpacked\resources\backend\src\app.js"
          if (Test-Path $backendInResources) {
            Write-Host "âœ… Backend included in build" -ForegroundColor Green
          } else {
            Write-Host "âŒ Backend NOT included!" -ForegroundColor Red
            exit 1
          }
        shell: pwsh

      - name: ğŸ“‹ Get version
        id: version
        run: |
          $version = node -p "require('./package.json').version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version" -ForegroundColor Green
        shell: pwsh

      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-electron/*.exe
            dist-electron/*.yml
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸ‰ Sistema Calzado - VersiÃ³n ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¥ InstalaciÃ³n
            1. Descarga `Sistema-Calzado-Setup-${{ steps.version.outputs.VERSION }}.exe`
            2. Ejecuta el instalador
            3. Sigue las instrucciones en pantalla
            
            ### âš ï¸ IMPORTANTE
            - **Node.js incluido**: No necesitas instalar Node.js por separado
            - **Primera instalaciÃ³n**: La aplicaciÃ³n puede tardar unos segundos en iniciar
            - **Antivirus**: Algunos antivirus pueden bloquear la primera ejecuciÃ³n
            
            ### âœ¨ CaracterÃ­sticas
            - âœ… Backend integrado (Node.js portable incluido)
            - âœ… Base de datos SQLite incluida
            - âœ… Interfaz moderna con React + Tailwind
            - âœ… Sistema de autenticaciÃ³n seguro
            - âœ… GestiÃ³n de inventario, ventas y proveedores
            - âœ… Actualizaciones automÃ¡ticas
            
            ### ğŸ“ Cambios en esta versiÃ³n
            Ver notas de lanzamiento automÃ¡ticas abajo.
            
            ---
            
            **ğŸ’» Requisitos:**
            - Windows 10/11 (64-bit)
            - 4GB RAM mÃ­nimo
            - 500MB espacio en disco
            
            **ğŸ› Â¿Problemas?**
            - Si el backend no inicia: Ejecuta como administrador
            - Si el antivirus lo bloquea: Agrega excepciÃ³n
            - Reporta bugs en [Issues](https://github.com/Juand2602/Maca-app-electron/issues)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Success
        run: |
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "âœ… Release created successfully!" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Green
        shell: pwsh