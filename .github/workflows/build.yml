name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install root dependencies
        run: npm ci

      - name: ğŸ“¦ Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: ğŸ—„ï¸ Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      - name: ğŸ¨ Verify Tailwind setup
        working-directory: frontend
        run: |
          echo "Checking Tailwind installation..."
          npm list tailwindcss postcss autoprefixer
          echo ""
          echo "Checking config files..."
          if (Test-Path "tailwind.config.js") { Write-Host "âœ… tailwind.config.js found" } else { Write-Host "âŒ tailwind.config.js NOT FOUND" }
          if (Test-Path "postcss.config.js") { Write-Host "âœ… postcss.config.js found" } else { Write-Host "âŒ postcss.config.js NOT FOUND" }
          if (Test-Path "vite.config.js") { Write-Host "âœ… vite.config.js found" } else { Write-Host "âŒ vite.config.js NOT FOUND" }
        shell: pwsh

      - name: ğŸ”¨ Build frontend
        working-directory: frontend
        run: |
          echo "Building frontend..."
          npm run build
          echo ""
          echo "Checking build output..."
          dir dist
          echo ""
          dir dist\assets
        shell: pwsh
        env:
          NODE_ENV: production

      - name: ğŸ”§ Build backend
        run: npm run build:backend

      - name: ğŸ” Verify backend files
        working-directory: backend
        run: |
          Write-Host "=== BACKEND FILES ===" -ForegroundColor Cyan
          if (Test-Path "src/app.js") {
            Write-Host "âœ… app.js found" -ForegroundColor Green
          } else {
            Write-Host "âŒ ERROR: app.js NOT found" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== BACKEND ROUTES ===" -ForegroundColor Cyan
          $routes = Get-ChildItem "src/routes" -Filter "*.js" -ErrorAction SilentlyContinue
          if ($routes) {
            Write-Host "âœ… Routes found:" -ForegroundColor Green
            $routes | ForEach-Object { Write-Host "   - $($_.Name)" }
          } else {
            Write-Host "âŒ ERROR: No routes found" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== PRISMA CLIENT ===" -ForegroundColor Cyan
          if (Test-Path "node_modules/.prisma/client") {
            Write-Host "âœ… Prisma Client generated" -ForegroundColor Green
          } else {
            Write-Host "âŒ ERROR: Prisma Client NOT generated" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== NODE MODULES ===" -ForegroundColor Cyan
          $nodeModulesSize = (Get-ChildItem "node_modules" -Recurse -File | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "âœ… node_modules size: $([math]::Round($nodeModulesSize, 2)) MB" -ForegroundColor Green
        shell: pwsh

      - name: ğŸ” Verify complete build
        run: |
          Write-Host "=== FRONTEND BUILD ===" -ForegroundColor Cyan
          if (Test-Path "frontend\dist\index.html") {
            Write-Host "âœ… index.html exists" -ForegroundColor Green
            Write-Host ""
            Write-Host "First 20 lines of index.html:" -ForegroundColor Yellow
            Get-Content "frontend\dist\index.html" -Head 20
          } else {
            Write-Host "âŒ index.html NOT FOUND" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== CSS FILES ===" -ForegroundColor Cyan
          $cssFiles = Get-ChildItem "frontend\dist\assets\*.css" -ErrorAction SilentlyContinue
          if ($cssFiles) {
            Write-Host "âœ… CSS files found:" -ForegroundColor Green
            $cssFiles | ForEach-Object { Write-Host "   - $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)" }
            Write-Host ""
            Write-Host "CSS content preview (first 30 lines):" -ForegroundColor Yellow
            Get-Content $cssFiles[0].FullName -Head 30
          } else {
            Write-Host "âŒ NO CSS FILES FOUND" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== JAVASCRIPT FILES ===" -ForegroundColor Cyan
          $jsFiles = Get-ChildItem "frontend\dist\assets\*.js" -ErrorAction SilentlyContinue
          if ($jsFiles) {
            Write-Host "âœ… JS files found:" -ForegroundColor Green
            $jsFiles | ForEach-Object { Write-Host "   - $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)" }
          } else {
            Write-Host "âŒ NO JS FILES FOUND" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== DATABASE ===" -ForegroundColor Cyan
          if (Test-Path "database\calzado.db") {
            Write-Host "âœ… Database file exists" -ForegroundColor Green
            $dbSize = (Get-Item "database\calzado.db").Length / 1KB
            Write-Host "   Size: $([math]::Round($dbSize, 2)) KB"
          } else {
            Write-Host "âš ï¸ WARNING: Database file NOT FOUND (will be created on first run)" -ForegroundColor Yellow
          }
        shell: pwsh

      - name: ğŸ“± Build Electron App
        run: npm run electron:build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Verify installer
        run: |
          Write-Host "=== ELECTRON BUILD OUTPUT ===" -ForegroundColor Cyan
          
          $exeFiles = Get-ChildItem "dist-electron" -Filter "*.exe" -ErrorAction SilentlyContinue
          if ($exeFiles) {
            Write-Host "âœ… Installers found:" -ForegroundColor Green
            $exeFiles | ForEach-Object { 
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              Write-Host "   - $($_.Name) ($sizeMB MB)"
            }
          } else {
            Write-Host "âŒ ERROR: No .exe files found in dist-electron" -ForegroundColor Red
            Write-Host "Contents of dist-electron:" -ForegroundColor Yellow
            Get-ChildItem "dist-electron" -Recurse | Select-Object FullName
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== UPDATE FILES ===" -ForegroundColor Cyan
          $ymlFiles = Get-ChildItem "dist-electron" -Filter "*.yml" -ErrorAction SilentlyContinue
          if ($ymlFiles) {
            Write-Host "âœ… Update files found:" -ForegroundColor Green
            $ymlFiles | ForEach-Object { Write-Host "   - $($_.Name)" }
          } else {
            Write-Host "âš ï¸ WARNING: No .yml update files found" -ForegroundColor Yellow
          }
        shell: pwsh

      - name: ğŸ“‹ Get version
        id: version
        run: |
          $version = node -p "require('./package.json').version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version" -ForegroundColor Green
        shell: pwsh

      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-electron/*.exe
            dist-electron/*.yml
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸ‰ Sistema Calzado - VersiÃ³n ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¥ InstalaciÃ³n
            1. Descarga `Sistema-Calzado-Setup-${{ steps.version.outputs.VERSION }}.exe`
            2. Ejecuta el instalador
            3. Sigue las instrucciones en pantalla
            4. La aplicaciÃ³n se iniciarÃ¡ automÃ¡ticamente
            
            ### ğŸ”„ ActualizaciÃ³n automÃ¡tica
            Si ya tienes la aplicaciÃ³n instalada:
            - Se actualizarÃ¡ automÃ¡ticamente al iniciar
            - RecibirÃ¡s una notificaciÃ³n cuando estÃ© disponible
            - Puedes instalar sobre la versiÃ³n anterior sin desinstalar
            
            ### âœ¨ CaracterÃ­sticas
            - âœ… Backend integrado (no requiere instalaciÃ³n separada)
            - âœ… Base de datos SQLite incluida
            - âœ… Interfaz moderna con React + Tailwind
            - âœ… Sistema de autenticaciÃ³n seguro
            - âœ… GestiÃ³n de inventario, ventas y proveedores
            
            ### ğŸ“ Cambios en esta versiÃ³n
            Ver notas de lanzamiento automÃ¡ticas abajo.
            
            ---
            
            **âš ï¸ Requisitos:**
            - Windows 10/11 (64-bit)
            - 4GB RAM mÃ­nimo
            - 500MB espacio en disco
            
            **ğŸ› Â¿Problemas?**
            - Reporta bugs en [Issues](https://github.com/Juand2602/Maca-app-electron/issues)
            - Consulta la documentaciÃ³n en el [Wiki](https://github.com/Juand2602/Maca-app-electron/wiki)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Success
        run: |
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "âœ… Release created successfully!" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“¦ Instalador disponible en GitHub Releases" -ForegroundColor Cyan
          Write-Host ""
        shell: pwsh