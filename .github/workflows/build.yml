name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install root dependencies
        run: npm ci

      - name: ğŸ“¦ Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: ğŸ—„ï¸ Setup Database
        working-directory: backend
        run: |
          Write-Host "=== SETUP DATABASE ===" -ForegroundColor Cyan
          
          # Crear directorio database en la RAÃZ del proyecto
          $rootPath = Split-Path -Parent $PWD
          $databaseDir = Join-Path $rootPath "database"
          
          if (!(Test-Path $databaseDir)) {
            New-Item -ItemType Directory -Path $databaseDir -Force | Out-Null
            Write-Host "âœ… Database directory created at: $databaseDir" -ForegroundColor Green
          }
          
          # Configurar DATABASE_URL apuntando a la raÃ­z
          $dbPath = Join-Path $databaseDir "calzado.db"
          $env:DATABASE_URL = "file:$dbPath"
          Write-Host "DATABASE_URL=$env:DATABASE_URL" -ForegroundColor Yellow
          
          # Crear archivo .env
          "DATABASE_URL=$env:DATABASE_URL" | Out-File -FilePath ".env" -Encoding UTF8
          
          Write-Host ""
          Write-Host "Generating Prisma Client..." -ForegroundColor Yellow
          npx prisma generate
          
          Write-Host ""
          Write-Host "Creating database and running migrations..." -ForegroundColor Yellow
          npx prisma migrate deploy
          
          Write-Host ""
          Write-Host "Seeding database with admin user..." -ForegroundColor Yellow
          npm run prisma:seed
          
          # Verificar que la DB se creÃ³ en la ubicaciÃ³n correcta
          Write-Host ""
          Write-Host "Verifying database creation..." -ForegroundColor Yellow
          
          if (Test-Path $dbPath) {
            $dbSize = [math]::Round((Get-Item $dbPath).Length / 1KB, 2)
            Write-Host "âœ… Database created successfully!" -ForegroundColor Green
            Write-Host "   Location: $dbPath" -ForegroundColor Cyan
            Write-Host "   Size: $dbSize KB" -ForegroundColor Cyan
          } else {
            Write-Host "âŒ ERROR: Database not found at: $dbPath" -ForegroundColor Red
            Write-Host ""
            Write-Host "Searching for database files..." -ForegroundColor Yellow
            Get-ChildItem -Path $rootPath -Filter "*.db" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "   Found: $($_.FullName)" -ForegroundColor Yellow
            }
            exit 1
          }
          
          # Verificar contenido de la base de datos
          Write-Host ""
          Write-Host "Verifying database content..." -ForegroundColor Yellow
          
          $verifyScript = @"
          const { PrismaClient } = require('@prisma/client');
          const prisma = new PrismaClient({
            datasources: { db: { url: 'file:$dbPath' } }
          });

          async function verify() {
            try {
              const userCount = await prisma.user.count();
              console.log('Users in database:', userCount);
              
              if (userCount > 0) {
                const admin = await prisma.user.findFirst({ where: { role: 'ADMIN' } });
                if (admin) {
                  console.log('Admin user found:', admin.email);
                }
              }
              
              await prisma.\$disconnect();
              process.exit(userCount > 0 ? 0 : 1);
            } catch (error) {
              console.error('Verification error:', error.message);
              process.exit(1);
            }
          }

          verify();
          "@
          
          $verifyScript | Out-File -FilePath "verify-db.js" -Encoding UTF8
          node verify-db.js
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Database verification passed!" -ForegroundColor Green
          } else {
            Write-Host "âŒ Database verification failed!" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "âœ… Database setup complete" -ForegroundColor Green
        shell: pwsh
        env:
          DATABASE_URL: "file:../database/calzado.db"

      - name: ğŸ”¨ Build frontend
        working-directory: frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“¥ Download Node.js portable
        run: |
          Write-Host "=== DOWNLOADING NODE.JS PORTABLE ===" -ForegroundColor Cyan
          
          $nodeVersion = "20.11.0"
          $downloadUrl = "https://nodejs.org/dist/v$nodeVersion/node-v$nodeVersion-win-x64.zip"
          $outputDir = "node-portable"
          $zipFile = "$outputDir\node.zip"
          $nodeExe = "$outputDir\node.exe"
          
          # Limpiar y crear directorio
          if (Test-Path $outputDir) {
            Remove-Item $outputDir -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
          
          Write-Host "Downloading from: $downloadUrl" -ForegroundColor Yellow
          
          # Descargar con progress
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile -UseBasicParsing
          
          if (!(Test-Path $zipFile)) {
            Write-Host "âŒ Download failed!" -ForegroundColor Red
            exit 1
          }
          
          $zipSize = [math]::Round((Get-Item $zipFile).Length / 1MB, 2)
          Write-Host "âœ… Download completed: $zipSize MB" -ForegroundColor Green
          
          # Extraer ZIP
          Write-Host "Extracting..." -ForegroundColor Yellow
          Expand-Archive -Path $zipFile -DestinationPath $outputDir -Force
          
          # Mover node.exe
          $extractedFolder = "$outputDir\node-v$nodeVersion-win-x64"
          
          if (!(Test-Path $extractedFolder)) {
            Write-Host "âŒ Extracted folder not found!" -ForegroundColor Red
            Write-Host "Contents:" -ForegroundColor Yellow
            Get-ChildItem $outputDir | ForEach-Object { Write-Host "   - $($_.Name)" }
            exit 1
          }
          
          Copy-Item "$extractedFolder\node.exe" $nodeExe -Force
          
          # Limpiar
          Remove-Item $extractedFolder -Recurse -Force
          Remove-Item $zipFile -Force
          
          # Verificar
          if (Test-Path $nodeExe) {
            $nodeSize = [math]::Round((Get-Item $nodeExe).Length / 1MB, 2)
            Write-Host "âœ… Node.js portable ready!" -ForegroundColor Green
            Write-Host "   Path: $nodeExe"
            Write-Host "   Size: $nodeSize MB"
            
            # Verificar que sea ejecutable
            try {
              $version = & $nodeExe --version
              Write-Host "   Version: $version" -ForegroundColor Green
            } catch {
              Write-Host "   âš ï¸ Could not verify executable" -ForegroundColor Yellow
            }
            
            if ($nodeSize -lt 20) {
              Write-Host "âŒ ERROR: File too small!" -ForegroundColor Red
              exit 1
            }
          } else {
            Write-Host "âŒ ERROR: node.exe not found after extraction!" -ForegroundColor Red
            exit 1
          }
        shell: pwsh

      - name: ğŸ” Verify backend structure
        working-directory: backend
        run: |
          Write-Host "=== BACKEND STRUCTURE ===" -ForegroundColor Cyan
          
          # Verificar app.js
          if (Test-Path "src/app.js") {
            Write-Host "âœ… app.js" -ForegroundColor Green
          } else {
            Write-Host "âŒ app.js NOT FOUND" -ForegroundColor Red
            exit 1
          }
          
          # Verificar rutas
          $routes = Get-ChildItem "src/routes" -Filter "*.js" -ErrorAction SilentlyContinue
          if ($routes) {
            Write-Host "âœ… Routes: $($routes.Count) files" -ForegroundColor Green
          } else {
            Write-Host "âŒ No routes found" -ForegroundColor Red
            exit 1
          }
          
          # Verificar Prisma Client
          if (Test-Path "node_modules/.prisma/client") {
            Write-Host "âœ… Prisma Client generated" -ForegroundColor Green
          } else {
            Write-Host "âŒ Prisma Client NOT generated" -ForegroundColor Red
            exit 1
          }
          
          # Verificar dependencias crÃ­ticas
          $criticalDeps = @("express", "cors", "@prisma/client", "bcryptjs", "jsonwebtoken")
          foreach ($dep in $criticalDeps) {
            if (Test-Path "node_modules/$dep") {
              Write-Host "âœ… $dep" -ForegroundColor Green
            } else {
              Write-Host "âŒ $dep MISSING" -ForegroundColor Red
              exit 1
            }
          }
        shell: pwsh

      - name: ğŸ“± Build Electron App
        run: npm run electron:build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Verify build output
        run: |
          Write-Host "=== BUILD OUTPUT ===" -ForegroundColor Cyan
          
          # Verificar instalador
          $installer = Get-ChildItem "dist-electron" -Filter "*Setup*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($installer) {
            $sizeMB = [math]::Round($installer.Length / 1MB, 2)
            Write-Host "âœ… Installer: $($installer.Name) ($sizeMB MB)" -ForegroundColor Green
          } else {
            Write-Host "âŒ Installer NOT found" -ForegroundColor Red
            exit 1
          }
          
          # Verificar Node.js en resources
          $nodeInResources = "dist-electron\win-unpacked\resources\node\node.exe"
          if (Test-Path $nodeInResources) {
            $nodeSize = [math]::Round((Get-Item $nodeInResources).Length / 1MB, 2)
            Write-Host "âœ… Node.js included in build: $nodeSize MB" -ForegroundColor Green
          } else {
            Write-Host "âŒ Node.js NOT included in build!" -ForegroundColor Red
            Write-Host "Resources directory structure:" -ForegroundColor Yellow
            if (Test-Path "dist-electron\win-unpacked\resources") {
              Get-ChildItem "dist-electron\win-unpacked\resources" -Recurse | Select-Object FullName | ForEach-Object { Write-Host "   $($_.FullName)" }
            }
            exit 1
          }
          
          # Verificar backend en resources
          $backendInResources = "dist-electron\win-unpacked\resources\backend\src\app.js"
          if (Test-Path $backendInResources) {
            Write-Host "âœ… Backend included in build" -ForegroundColor Green
          } else {
            Write-Host "âŒ Backend NOT included!" -ForegroundColor Red
            exit 1
          }
        shell: pwsh

      - name: ğŸ“‹ Get version
        id: version
        run: |
          $version = node -p "require('./package.json').version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version" -ForegroundColor Green
        shell: pwsh

      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-electron/*.exe
            dist-electron/*.yml
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸ‰ Sistema Calzado - VersiÃ³n ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¥ InstalaciÃ³n
            1. Descarga `Sistema-Calzado-Setup-${{ steps.version.outputs.VERSION }}.exe`
            2. Ejecuta el instalador
            3. Sigue las instrucciones en pantalla
            
            ### âš ï¸ IMPORTANTE
            - **Node.js incluido**: No necesitas instalar Node.js por separado
            - **Primera instalaciÃ³n**: La aplicaciÃ³n puede tardar unos segundos en iniciar
            - **Antivirus**: Algunos antivirus pueden bloquear la primera ejecuciÃ³n
            
            ### âœ¨ CaracterÃ­sticas
            - âœ… Backend integrado (Node.js portable incluido)
            - âœ… Base de datos SQLite incluida
            - âœ… Interfaz moderna con React + Tailwind
            - âœ… Sistema de autenticaciÃ³n seguro
            - âœ… GestiÃ³n de inventario, ventas y proveedores
            - âœ… Actualizaciones automÃ¡ticas
            
            ### ğŸ“ Cambios en esta versiÃ³n
            Ver notas de lanzamiento automÃ¡ticas abajo.
            
            ---
            
            **ğŸ’» Requisitos:**
            - Windows 10/11 (64-bit)
            - 4GB RAM mÃ­nimo
            - 500MB espacio en disco
            
            **ğŸ› Â¿Problemas?**
            - Si el backend no inicia: Ejecuta como administrador
            - Si el antivirus lo bloquea: Agrega excepciÃ³n
            - Reporta bugs en [Issues](https://github.com/Juand2602/Maca-app-electron/issues)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Success
        run: |
          Write-Host ""
          Write-Host "================================================" -ForegroundColor Green
          Write-Host "âœ… Release created successfully!" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Green
        shell: pwsh