name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger en tags tipo v1.0.0, v1.2.3, etc.

jobs:
  release:
    runs-on: windows-latest  # Solo Windows

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ===== INSTALAR DEPENDENCIAS =====
      
      - name: ğŸ“¦ Install root dependencies
        run: npm ci

      - name: ğŸ“¦ Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # ===== GENERAR PRISMA CLIENT =====
      
      - name: ğŸ—„ï¸ Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      # ===== VERIFICAR CONFIGURACIÃ“N DE TAILWIND =====
      
      - name: ğŸ¨ Verify Tailwind setup
        working-directory: frontend
        run: |
          echo "Checking Tailwind installation..."
          npm list tailwindcss postcss autoprefixer
          echo ""
          echo "Checking config files..."
          dir tailwind.config.js postcss.config.js vite.config.js
        shell: pwsh
      
      # ===== BUILD FRONTEND =====
      
      - name: ğŸ”¨ Build frontend
        working-directory: frontend
        run: |
          echo "Building frontend..."
          npm run build
          echo ""
          echo "Checking build output..."
          dir dist
          echo ""
          dir dist\assets
        shell: pwsh
        env:
          NODE_ENV: production

      # ===== BUILD BACKEND (PKG) =====
      
      - name: ğŸ”§ Build backend executable
        run: npm run build:backend

      # ===== VERIFICAR ARCHIVOS =====
      
      - name: ğŸ” Verify backend.exe exists
        run: |
          if (Test-Path "dist-electron/backend.exe") {
            Write-Host "âœ… backend.exe encontrado"
            Get-Item "dist-electron/backend.exe" | Format-List
          } else {
            Write-Host "âŒ ERROR: backend.exe NO encontrado"
            exit 1
          }
        shell: pwsh

      # ===== VERIFICAR BUILD COMPLETO =====
      
      - name: ğŸ” Verify complete build
        run: |
          echo "=== FRONTEND BUILD ==="
          if (Test-Path "frontend\dist\index.html") {
            Write-Host "âœ… index.html exists" -ForegroundColor Green
            Get-Content "frontend\dist\index.html" -Head 20
          } else {
            Write-Host "âŒ index.html NOT FOUND" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== CSS FILES ==="
          $cssFiles = Get-ChildItem "frontend\dist\assets\*.css" -ErrorAction SilentlyContinue
          if ($cssFiles) {
            Write-Host "âœ… CSS files found:" -ForegroundColor Green
            $cssFiles | ForEach-Object { Write-Host $_.Name "(" $_.Length "bytes)" }
            Write-Host ""
            Write-Host "CSS content preview:"
            Get-Content $cssFiles[0].FullName -Head 30
          } else {
            Write-Host "âŒ NO CSS FILES FOUND" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "=== BACKEND BUILD ==="
          if (Test-Path "dist-electron\backend.exe") {
            Write-Host "âœ… backend.exe exists" -ForegroundColor Green
            Get-Item "dist-electron\backend.exe" | ForEach-Object { Write-Host $_.Name "(" $_.Length "bytes)" }
          } else {
            Write-Host "âŒ backend.exe NOT FOUND" -ForegroundColor Red
            exit 1
          }
        shell: pwsh
      
      # ===== BUILD ELECTRON =====
      
      - name: ğŸ“± Build Electron App
        run: npm run electron:build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===== GET VERSION =====
      
      - name: ğŸ“‹ Get version
        id: version
        run: |
          $version = node -p "require('./package.json').version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        shell: pwsh

      # ===== CREATE RELEASE =====
      
      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist-electron/*.exe
            dist-electron/*.yml
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸ‰ Sistema Calzado - VersiÃ³n ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“¥ InstalaciÃ³n
            1. Descarga `Sistema-Calzado-Setup-${{ steps.version.outputs.VERSION }}.exe`
            2. Ejecuta el instalador
            3. Sigue las instrucciones en pantalla
            4. Al abrir, activa tu licencia
            
            ### ğŸ”„ ActualizaciÃ³n automÃ¡tica
            Si ya tienes la aplicaciÃ³n instalada:
            - Se actualizarÃ¡ automÃ¡ticamente al iniciar
            - RecibirÃ¡s una notificaciÃ³n cuando estÃ© disponible
            
            ### ğŸ“ Cambios en esta versiÃ³n
            Ver notas de lanzamiento automÃ¡ticas abajo.
            
            ---
            
            **âš ï¸ Requisitos:**
            - Windows 10/11 (64-bit)
            - 4GB RAM mÃ­nimo
            - 500MB espacio en disco
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Success
        run: |
          echo "âœ… Release v${{ steps.version.outputs.VERSION }} created successfully!"
          echo "ğŸ“¦ Instalador disponible en GitHub Releases"